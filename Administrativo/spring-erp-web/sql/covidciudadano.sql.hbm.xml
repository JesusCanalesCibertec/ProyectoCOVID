<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE hibernate-mapping PUBLIC "-//Hibernate/Hibernate Mapping DTD 3.0//EN"
"http://hibernate.sourceforge.net/hibernate-mapping-3.0.dtd">
<hibernate-mapping>
  <sql-query name="covidciudadano.filtroContar">
	SELECT 
		COUNT(1)
		FROM CIUDADANO C
		INNER JOIN PAIS P ON P.ID_PAIS = C.ID_PAIS
		INNER JOIN DEPARTAMENTO DEP	ON DEP.ID_DEPARTAMENTO = C.ID_DEPARTAMENTO
		INNER JOIN PROVINCIA PRO	ON PRO.ID_PROVINCIA = C.ID_PROVINCIA AND PRO.ID_DEPARTAMENTO = C.ID_DEPARTAMENTO
		INNER JOIN DISTRITO DIS		ON DIS.ID_DISTRITO = C.ID_DISTRITO AND DIS.ID_PROVINCIA = C.ID_PROVINCIA AND DIS.ID_DEPARTAMENTO = C.ID_DEPARTAMENTO
		where
		C.NRO_DOC like '%'+ isnull(:p_documento, C.NRO_DOC) + '%' and 
		(C.NOM_CIUDADANO  like '%' + isnull(:p_nombre, C.NOM_CIUDADANO) + '%' OR C.APE_CIUDADANO like '%' + isnull(:p_nombre, C.APE_CIUDADANO) + '%') AND
		C.ID_PAIS = ISNULL(:p_pais, C.ID_PAIS) AND 
		C.ID_DEPARTAMENTO = ISNULL(:p_departamento, C.ID_DEPARTAMENTO) AND 
		C.ID_PROVINCIA = ISNULL(:p_provincia, C.ID_PROVINCIA) AND 
		C.ID_DISTRITO = ISNULL(:p_distrito, C.ID_DISTRITO) AND 
		C.TIPO_DOCUMENTO = ISNULL(:p_tipo, C.TIPO_DOCUMENTO) AND
		C.ESTADO = ISNULL(:p_estado, C.ESTADO)	
  </sql-query>
  <sql-query name="covidciudadano.filtroPaginacion">	 
	SELECT 
		C.COD_CIUDADANO,
		C.NRO_DOC,
		C.NOM_CIUDADANO+' '+C.APE_CIUDADANO AS NOMBRECOMPLETO,
		C.ID_PAIS,
		P.DESCRIPCION AS NOM_PAIS,
		C.DIRECCION,
		C.ID_DEPARTAMENTO,
		DEP.DESCRIPCION AS NOMDEPARTAMENTO,
		C.ID_PROVINCIA,
		PRO.DESCRIPCION AS NOMPROVINCIA,
		C.ID_DISTRITO,
		DIS.DESCRIPCION AS NOMDISTRITO,
		C.ESTADO,
		RES.NOM_ESTADO,
		DATEDIFF(yy,CONVERT(DATETIME, c.FECHA_NAC),GETDATE()) AS AGE,
		C.NOM_CIUDADANO AS NOMBRE,
		C.APE_CIUDADANO AS APELLIDO,
		(SELECT COUNT(1) FROM TRIAJE T WHERE T.COD_CIUDADANO = C.COD_CIUDADANO) AS CANTIDAD,
		C.TIPO_DOCUMENTO,
		ROW_NUMBER() OVER (ORDER BY C.COD_CIUDADANO desc) AS Seq
		FROM CIUDADANO C
		INNER JOIN PAIS P ON P.ID_PAIS = C.ID_PAIS
		INNER JOIN DEPARTAMENTO DEP	ON DEP.ID_DEPARTAMENTO = C.ID_DEPARTAMENTO
		INNER JOIN PROVINCIA PRO	ON PRO.ID_PROVINCIA = C.ID_PROVINCIA AND PRO.ID_DEPARTAMENTO = C.ID_DEPARTAMENTO
		INNER JOIN DISTRITO DIS		ON DIS.ID_DISTRITO = C.ID_DISTRITO AND DIS.ID_PROVINCIA = C.ID_PROVINCIA AND DIS.ID_DEPARTAMENTO = C.ID_DEPARTAMENTO
		INNER JOIN RESULTADO RES	ON RES.COD_ESTADO = C.ESTADO
	where
		C.NRO_DOC like '%'+ isnull(:p_documento, C.NRO_DOC) + '%' and 
		(C.NOM_CIUDADANO  like '%' + isnull(:p_nombre, C.NOM_CIUDADANO) + '%' OR C.APE_CIUDADANO like '%' + isnull(:p_nombre, C.APE_CIUDADANO) + '%') AND
		C.ID_PAIS = ISNULL(:p_pais, C.ID_PAIS) AND 
		C.ID_DEPARTAMENTO = ISNULL(:p_departamento, C.ID_DEPARTAMENTO) AND 
		C.ID_PROVINCIA = ISNULL(:p_provincia, C.ID_PROVINCIA) AND 
		C.ID_DISTRITO = ISNULL(:p_distrito, C.ID_DISTRITO) AND 
		C.TIPO_DOCUMENTO = ISNULL(:p_tipo, C.TIPO_DOCUMENTO) AND 
		C.ESTADO = ISNULL(:p_estado, C.ESTADO)	
  </sql-query>
  
  
  	<sql-query name="covidciudadano.listarpie">
	
		<![CDATA[
					DECLARE @TABLA TABLE (NOMBRE VARCHAR(500), CANTIDAD INT)
			DECLARE @TOTAL INT = (SELECT COUNT(1) FROM CIUDADANO)

			INSERT INTO @TABLA
			SELECT 
			R.NOM_ESTADO AS NOMBRE,
			(SELECT COUNT(1) FROM CIUDADANO C WHERE C.ESTADO = R.COD_ESTADO) AS CANTIDAD
			FROM RESULTADO R

		
			DECLARE @TABLA2 TABLE (NOMBRE VARCHAR(500), CANTIDAD INT, PORCENTAJE DECIMAL(5,2))
			INSERT INTO @TABLA2
			SELECT T.NOMBRE,T.CANTIDAD,
			CAST(ROUND(case T.CANTIDAD when 0 then 0 else T.CANTIDAD*100.00/@TOTAL end,2) AS DECIMAL(5,2)) AS PORCENTAJE
			FROM @TABLA T

			IF @TOTAL = 0 
			   DELETE FROM @TABLA2
			ELSE
				--REDONDEAMOS LA SUMA A 100
				DECLARE @SUMA DECIMAL(5,2) = (SELECT SUM(T2.PORCENTAJE) FROM @TABLA2 T2)
				DECLARE @MAYOR DECIMAL(5,2) = (SELECT MAX(T2.PORCENTAJE) FROM @TABLA2 T2) 
				DECLARE @MENOR DECIMAL(5,2) =(SELECT MIN (T2.PORCENTAJE) FROM @TABLA2 T2) 

				IF @SUMA <> 100 
					UPDATE @TABLA2 SET PORCENTAJE = PORCENTAJE - (@SUMA-100) WHERE PORCENTAJE = @MAYOR

			SELECT * FROM @TABLA2

		]]>
		
	</sql-query>
	
	<sql-query name="covidciudadano.listarpiexDepartamento">
	
		<![CDATA[

			DECLARE @TABLA TABLE (NOMBRE VARCHAR(500), CANTIDAD INT)
			DECLARE @TOTAL INT = (SELECT COUNT(1) FROM CIUDADANO C WHERE C.ID_DEPARTAMENTO = :pDepartamento)

			INSERT INTO @TABLA
			SELECT 
			R.NOM_ESTADO AS NOMBRE,
			(SELECT COUNT(1) FROM CIUDADANO C WHERE C.ESTADO = R.COD_ESTADO AND C.ID_DEPARTAMENTO = :pDepartamento) AS CANTIDAD
			FROM RESULTADO R

		
			DECLARE @TABLA2 TABLE (NOMBRE VARCHAR(500), CANTIDAD INT, PORCENTAJE DECIMAL(5,2))
			INSERT INTO @TABLA2
			SELECT T.NOMBRE,T.CANTIDAD,
			CAST(ROUND(case T.CANTIDAD when 0 then 0 else T.CANTIDAD*100.00/@TOTAL end,2) AS DECIMAL(5,2)) AS PORCENTAJE
			FROM @TABLA T

		
			IF @TOTAL = 0 
			   DELETE FROM @TABLA2
			ELSE
				--REDONDEAMOS LA SUMA A 100
				DECLARE @SUMA DECIMAL(5,2) = (SELECT SUM(T2.PORCENTAJE) FROM @TABLA2 T2)
				DECLARE @MAYOR DECIMAL(5,2) = (SELECT MAX(T2.PORCENTAJE) FROM @TABLA2 T2) 
				DECLARE @MENOR DECIMAL(5,2) =(SELECT MIN (T2.PORCENTAJE) FROM @TABLA2 T2) 

				IF @SUMA <> 100 
					UPDATE @TABLA2 SET PORCENTAJE = PORCENTAJE - (@SUMA-100) WHERE PORCENTAJE = @MAYOR

			SELECT * FROM @TABLA2

		]]>
		
	</sql-query>
	
	<sql-query name="covidciudadano.listarpiexProvincia">
	
		<![CDATA[
		DECLARE @TABLA TABLE (NOMBRE VARCHAR(500), CANTIDAD INT)
			DECLARE @TOTAL INT = (SELECT COUNT(1) FROM CIUDADANO C WHERE C.ID_DEPARTAMENTO = :pDepartamento AND C.ID_PROVINCIA = :pProvincia)

			INSERT INTO @TABLA
			SELECT 
			R.NOM_ESTADO AS NOMBRE,
			(SELECT COUNT(1) FROM CIUDADANO C WHERE C.ESTADO = R.COD_ESTADO AND C.ID_DEPARTAMENTO = :pDepartamento AND C.ID_PROVINCIA = :pProvincia) AS CANTIDAD
			FROM RESULTADO R

		
			DECLARE @TABLA2 TABLE (NOMBRE VARCHAR(500), CANTIDAD INT, PORCENTAJE DECIMAL(5,2))
			INSERT INTO @TABLA2
			SELECT T.NOMBRE,T.CANTIDAD,
			CAST(ROUND(case T.CANTIDAD when 0 then 0 else T.CANTIDAD*100.00/@TOTAL end,2) AS DECIMAL(5,2)) AS PORCENTAJE
			FROM @TABLA T

		
			IF @TOTAL = 0 
			   DELETE FROM @TABLA2
			ELSE
				--REDONDEAMOS LA SUMA A 100
				DECLARE @SUMA DECIMAL(5,2) = (SELECT SUM(T2.PORCENTAJE) FROM @TABLA2 T2)
				DECLARE @MAYOR DECIMAL(5,2) = (SELECT MAX(T2.PORCENTAJE) FROM @TABLA2 T2) 
				DECLARE @MENOR DECIMAL(5,2) =(SELECT MIN (T2.PORCENTAJE) FROM @TABLA2 T2) 

				IF @SUMA <> 100 
					UPDATE @TABLA2 SET PORCENTAJE = PORCENTAJE - (@SUMA-100) WHERE PORCENTAJE = @MAYOR

			SELECT * FROM @TABLA2
		]]>
		
	</sql-query>
	
	<sql-query name="covidciudadano.listarpiexDistrito">
	
		<![CDATA[
		DECLARE @TABLA TABLE (NOMBRE VARCHAR(500), CANTIDAD INT)
			DECLARE @TOTAL INT = (SELECT COUNT(1) FROM CIUDADANO C WHERE C.ID_DEPARTAMENTO = :pDepartamento AND C.ID_PROVINCIA = :pProvincia AND c.ID_DISTRITO = :pDistrito)

			INSERT INTO @TABLA
			SELECT 
			R.NOM_ESTADO AS NOMBRE,
			(SELECT COUNT(1) FROM CIUDADANO C WHERE C.ESTADO = R.COD_ESTADO AND C.ID_DEPARTAMENTO = :pDepartamento AND C.ID_PROVINCIA = :pProvincia AND c.ID_DISTRITO = :pDistrito) AS CANTIDAD
			FROM RESULTADO R

		
			DECLARE @TABLA2 TABLE (NOMBRE VARCHAR(500), CANTIDAD INT, PORCENTAJE DECIMAL(5,2))
			INSERT INTO @TABLA2
			SELECT T.NOMBRE,T.CANTIDAD,
			CAST(ROUND(case T.CANTIDAD when 0 then 0 else T.CANTIDAD*100.00/@TOTAL end,2) AS DECIMAL(5,2)) AS PORCENTAJE
			FROM @TABLA T

		
			IF @TOTAL = 0 
			   DELETE FROM @TABLA2
			ELSE
				--REDONDEAMOS LA SUMA A 100
				DECLARE @SUMA DECIMAL(5,2) = (SELECT SUM(T2.PORCENTAJE) FROM @TABLA2 T2)
				DECLARE @MAYOR DECIMAL(5,2) = (SELECT MAX(T2.PORCENTAJE) FROM @TABLA2 T2) 
				DECLARE @MENOR DECIMAL(5,2) =(SELECT MIN (T2.PORCENTAJE) FROM @TABLA2 T2) 

				IF @SUMA <> 100 
					UPDATE @TABLA2 SET PORCENTAJE = PORCENTAJE - (@SUMA-100) WHERE PORCENTAJE = @MAYOR

			SELECT * FROM @TABLA2
		]]>
		
	</sql-query>
</hibernate-mapping>
