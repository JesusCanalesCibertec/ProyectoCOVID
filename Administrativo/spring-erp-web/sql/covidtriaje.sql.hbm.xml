<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE hibernate-mapping PUBLIC "-//Hibernate/Hibernate Mapping DTD 3.0//EN"
"http://hibernate.sourceforge.net/hibernate-mapping-3.0.dtd">
<hibernate-mapping>

  <sql-query name="covidtriaje.listarporciudadano">
      
	DECLARE @COD_CIUDADANO INT = :pIdCiudadano
	select * from (
		select 
		cast(ROW_NUMBER() OVER (ORDER BY TRI.COD_TRIAJE) as Int) as Seq,
		(SELECT COUNT(1) FROM (
		SELECT COLUMNA, RESPUESTA  FROM (SELECT DIS_GUS, TOS, DOLOR, DIFI, NASAL, FIEBRE FROM TRIAJE WHERE COD_CIUDADANO = @COD_CIUDADANO and COD_TRIAJE = TRI.COD_TRIAJE) p  
		UNPIVOT (RESPUESTA FOR COLUMNA IN (DIS_GUS, TOS, DOLOR, DIFI, NASAL, FIEBRE))AS unpvt) AS TEMPORAL WHERE TEMPORAL.RESPUESTA = 'SI') as num_sintomas,
		(SELECT COUNT(1) FROM (
		SELECT COLUMNA, RESPUESTA  FROM (SELECT SITUACION1, SITUACION2, SITUACION3 FROM TRIAJE WHERE COD_CIUDADANO = @COD_CIUDADANO and COD_TRIAJE = TRI.COD_TRIAJE) p  
		UNPIVOT (RESPUESTA FOR COLUMNA IN (SITUACION1, SITUACION2, SITUACION3))AS unpvt) AS TEMPORAL WHERE TEMPORAL.RESPUESTA = 'SI') as num_situaciones,
		(SELECT COUNT(1) FROM (
		SELECT COLUMNA, RESPUESTA  FROM (SELECT OBESIDAD, PULMONAR, ASMA, DIABETES, HIPERTENSION, CARDIO, RENAL, CANCER FROM TRIAJE WHERE COD_CIUDADANO = @COD_CIUDADANO and COD_TRIAJE = TRI.COD_TRIAJE) p  
		UNPIVOT (RESPUESTA FOR COLUMNA IN (OBESIDAD, PULMONAR, ASMA, DIABETES, HIPERTENSION, CARDIO, RENAL, CANCER))AS unpvt) AS TEMPORAL WHERE TEMPORAL.RESPUESTA = 'SI') as num_cronicos,
		TRI.COD_TRIAJE,
		TRI.FECHA_REGISTRO,
		RES.COLOR
		from TRIAJE TRI 
		INNER JOIN RESULTADO RES ON TRI.ESTADO = RES.COD_ESTADO
		where COD_CIUDADANO = @COD_CIUDADANO 
	) tabla order by tabla.Seq desc
	</sql-query>


</hibernate-mapping>
